---
title: "Scanner tool for SuS: Revolutions in Biomedicine"
date: "28/05/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(plotly)
library(lubridate)

ygr1 = read.csv("C:/Users/oboyd/Documents/ygr1_check2.csv")

all_in = readRDS("C:/Users/oboyd/Documents/all_in.RDS")

```


## Monitoring emerging variants

As part of the UK pandemic response, we develop methods to identify and monitor emerging variants of interest. Your job today is to look at clusters of interest, including specific lineages or lineage and mutation combinations, and report on growth rates. We wil look at outputs from the scanning tool designed for Public Health England (PHE) as part of the SARS-CoV-2 pandemic response to monitor emerging variants of interest or concern. 

### PHE situation report

Imagine the date is the 28th of May, 2021. PHE has requested a situation report on the top growth clusters of interest, and more specifically on the top growth rates of B.1.617.2 in the country as this is a new VOC, as well as clusters associated with mutations **S:L452R** and **S:K417N**. Feel free to include any other information about VUI/VOC of interest (see Table 1). This report should be about three pages in length, and include a few figures or tables from the scanning tool as part of the report. Factors to consider when writing your report: 

1. Which lineages are the highest growth rate lineages? 
2. Where are these lineages occuring in the population? (Use [google maps](https://www.google.co.uk/maps/place/United+Kingdom/@54.2184924,-13.4306024,5z/data=!3m1!4b1!4m5!3m4!1s0x25a3b1142c791a9:0xc4f8a0433288257a!8m2!3d55.378051!4d-3.435973) to look up UK locations if uncertain)
3. How does their growth look over time? What about their frequency? How many LTLAs do we see them in? 
4. Do we see any mutations of interest or concern with high growth (to be discussed further in the mutations section below)? 
5. How might current non-pharmaceutical interventions impact growth rates (remember the date is [28/05/2021](https://www.gov.uk/government/publications/covid-19-response-spring-2021/covid-19-response-spring-2021-summary) so the so called ["freedom day"](https://www.nbcnews.com/news/world/freedom-day-england-prepares-reopen-despite-skyrocketing-covid-cases-n1274311) has not occured yet)? 

Additionally, remember that we are only including P1 (lighthouse) samples in our scanning tool and outputs. This is always good to mention. Why? Because different sampling methods can lead to sample bias in our results. **Discuss with your classmates how we might bias our results if we included hospital cases in our scanner tool.** 

_**N.B** You will include this report as part of the summative SuS Revolutions in Biomedicine portfolio. You are not expected to complete this report in the practical period, so please take the time to discuss outputs with your classmates as you work through the practical together._


#### Lineage nomenclature

Table 1. provides a reference of lineages of interest or concern that you should consider looking at in the scanner outputs. Please note, all scanner outputs utlise the pangolin lineage nomenclature, but feel free to call these be either WHO, pangolin lineage nomenclature or VOC/VUI designation in your report write up. 


<div style="text-align:center"><img src="C:/Users/oboyd/Documents/table1.png" /></div>
<p>&nbsp;</p>
<p>&nbsp;</p>


### Growth rates from scanner output

We first look at growth rates for all clusters in the most recent scanner run, with date of last sample from the cluster of interest on the x axis. Although there are quite a few clusters on the image, notice that we can toggle clusters with specific lineages on and off the figure by clicking on a lineage in the legend. Although clusters can (and generally do) contain more than one lineage, we identify which lineage is most prominent in a cluster and label a cluster as "lineage +". Notice the graph has lots of functional features, including zooming in and selecting specific regions of the plot. For example, use box select to look at only clusters with a most recent sample date between May 01 and May 15. You can download the plot as a png as well. 


```{r figure1, echo=FALSE}

ygr1$most_recent_tip = dmy(ygr1$most_recent_tip)
p = ggplot(ygr1) + geom_point(aes(x = most_recent_tip, logistic_growth_rate, color = lineage, size = cluster_size))  +
  theme_bw() + labs(color = "", size = "", x = "Most recent sample date", y = "Relative growth rate per generaton")

ggplotly(p)

```


Questions to consider and discuss with your classmates when looking at growth rates between clusters: 

Which clusters show the highest growth rates? What lineages do they include? How recent are the sample dates? Do we see clusters with higher growth rates but less recent samples? More specifically, what do we see happening with B.1.1.7 and B.1.617.2? B.1.1.7 has been the dominant lineage in circulation since the start of the pandemic. However, B.1.617.2 has recently shown potential transmission advantage. How large (number of sequences) are the clusters for B.1.617.2, B.1.617.2+ and B.1.1.7? Where do we see the largest 
B.1.1.7 clusters? Where do we see the largest B.1.617.2 clusters? What do these findings suggest to you as an epidemiologist? 

### Growth rates over time

Next, we look at a selection of scanner runs (April 01 - May 17, 2021) and lineages of interest over time, to see how growth rate estimates have changed with the emergence of lineages of interest. It is important to consider how growth rates change over time, as it is possible clusters misappear to have high growth due multiple introductions or importations into the circulating population from the international reservoir. **Discuss why this would bias growth estimates with your classmates and consider when B.1.617.2 is thought to have been first introduced into the UK population in your discussion**. 

This figure shows B.1.1.7, B.1.351, B.1.525, B.1.617.2 and C.36 scanner growth rate estimates from multiple scanner runs. 



```{r figure2, echo = FALSE}

all_in$lineage = all_in$lineage2
p2 = ggplot(all_in[all_in$most_recent_tip > ymd("2021-04-01") & !is.na(all_in$lineage) & all_in$min_size != "min = 10",]) + geom_point(aes(most_recent_tip, logistic_growth_rate, 
                                 color = lineage,
                                size = cluster_size
), alpha = 0.8) + 
  #scale_shape_manual(values = c(1,6)) +
  #geom_line(aes(ymd(end_date), logistic_growth_rate, group = lineage, color = lineage)) +
  theme_bw() + #scale_color_distiller(palette = "Oranges") + scale_fill_distiller(palette = "") + 
  scale_color_brewer(palette = "Dark2")+
  #facet_wrap(~as.character(flag), ncol = 2) + 
  ylab("Relative growth rate per generation") + xlab("Most recent sample date") + 
  labs(color = "", size = "", shape = "", fill = "") + 
  geom_hline(yintercept = 0, color = "grey", linetype="dashed")


ggplotly(p2)

```

Discuss with your classmates what this output suggests in terms of growth for different VOC/VUI shown. Remember to again consider things such as cluster size, most recent sample date, and non-pharmaceutical interventions that might have been in place at diferent times in the outbreak. As a reference point, during peak of the second wave (~ Jan 2021) when the UK was in lockdown, a relative growth rate per generation of 0.2 or greater was considerd to be a high growth rate (with in the top 5 growth clusters). Referring back to the previous figure, consider where the highest growth clusters are now in terms of growth rate. 















